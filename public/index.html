<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Reminders</title>
  <style>
    :root {
      --bg-primary: #000000;
      --bg-secondary: #1c1c1e;
      --bg-tertiary: #2c2c2e;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --text-tertiary: #636366;
      --accent-blue: #0a84ff;
      --accent-green: #30d158;
      --accent-orange: #ff9f0a;
      --accent-red: #ff453a;
      --accent-purple: #bf5af2;
      --accent-yellow: #ffd60a;
      --separator: #38383a;
      --radius-sm: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      position: fixed;
      width: 100%;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
    }

    /* App Container */
    .app {
      display: flex;
      height: 100%;
      max-width: 1400px;
      margin: 0 auto;
      overscroll-behavior: none;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--separator);
      display: flex;
      flex-direction: column;
      padding: 16px 0;
      overscroll-behavior: none;
    }

    .sidebar-header {
      padding: 0 16px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title {
      font-size: 22px;
      font-weight: 700;
    }

    .add-folder-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: none;
      color: var(--accent-blue);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s;
    }

    .add-folder-btn:active {
      transform: scale(0.9);
    }

    /* Smart Lists */
    .smart-lists {
      padding: 0 16px 16px;
    }

    .smart-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 2px;
    }

    .smart-item:hover {
      background: var(--bg-tertiary);
    }

    .smart-item.active {
      background: var(--bg-tertiary);
    }

    .smart-icon {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      margin-right: 12px;
    }

    .smart-icon.today { background: var(--accent-blue); }
    .smart-icon.scheduled { background: var(--accent-red); }
    .smart-icon.all { background: var(--text-tertiary); }
    .smart-icon.completed { background: var(--accent-green); }

    .smart-name {
      flex: 1;
      font-size: 15px;
      font-weight: 500;
    }

    .smart-count {
      font-size: 15px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    /* Folders Section */
    .folders-section {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-secondary);
      font-weight: 600;
      letter-spacing: 0.5px;
      padding: 8px 12px;
      margin-top: 8px;
    }

    .folder-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 2px;
    }

    .folder-item:hover {
      background: var(--bg-tertiary);
    }

    .folder-item.active {
      background: var(--bg-tertiary);
    }

    .folder-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 12px;
    }

    .folder-icon {
      margin-right: 10px;
      font-size: 16px;
    }

    .folder-name {
      flex: 1;
      font-size: 15px;
      font-weight: 500;
    }

    .folder-count {
      font-size: 15px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      overscroll-behavior: none;
    }

    .main-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--separator);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      font-size: 28px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: none;
      color: var(--accent-blue);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s;
    }

    .icon-btn:active {
      transform: scale(0.9);
    }

    /* Quick Add */
    .quick-add {
      padding: 16px 24px;
      border-bottom: 1px solid var(--separator);
    }

    .quick-add-input {
      width: 100%;
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius-xl);
      padding: 14px 18px;
      font-size: 16px;
      color: var(--text-primary);
      outline: none;
    }

    .quick-add-input::placeholder {
      color: var(--text-secondary);
    }

    .quick-add-meta {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      padding-left: 6px;
    }

    .meta-btn {
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius-md);
      color: var(--accent-blue);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Reminders List */
    .reminders-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 24px 100px;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .reminder-item {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: transform 0.1s, background 0.15s;
      position: relative;
    }

    .reminder-item:hover {
      background: var(--bg-tertiary);
    }

    .reminder-item:active {
      transform: scale(0.995);
    }

    .reminder-item.completed .reminder-title {
      text-decoration: line-through;
      color: var(--text-secondary);
    }

    .reminder-item.priority-high {
      border-left: 3px solid var(--accent-red);
    }

    .reminder-item.priority-normal {
      border-left: 3px solid var(--accent-orange);
    }

    .reminder-item.priority-low {
      border-left: 3px solid var(--accent-blue);
    }

    .reminder-main {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid var(--text-tertiary);
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 2px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .checkbox:hover {
      border-color: var(--accent-blue);
    }

    .checkbox.checked {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
    }

    .checkbox.checked::after {
      content: '‚úì';
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .reminder-content {
      flex: 1;
      min-width: 0;
    }

    .reminder-title {
      font-size: 16px;
      font-weight: 500;
      line-height: 1.4;
      word-break: break-word;
    }

    .reminder-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .reminder-date {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .reminder-date.overdue {
      color: var(--accent-red);
    }

    .reminder-date.today {
      color: var(--accent-orange);
    }

    .reminder-folder {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .subtasks-preview {
      margin-top: 10px;
      margin-left: 34px;
    }

    .subtask-mini {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .subtask-mini.completed {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .subtask-mini::before {
      content: '‚óã';
      font-size: 10px;
    }

    .subtask-mini.completed::before {
      content: '‚úì';
      color: var(--accent-green);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-subtext {
      font-size: 15px;
      opacity: 0.8;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--separator);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(90vh - 140px);
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      background: var(--bg-tertiary);
      border: none;
      border-radius: var(--radius-md);
      padding: 12px 14px;
      font-size: 16px;
      color: var(--text-primary);
      outline: none;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .priority-options {
      display: flex;
      gap: 8px;
    }

    .priority-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--bg-tertiary);
      border-radius: var(--radius-md);
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .priority-btn:hover {
      border-color: var(--text-tertiary);
    }

    .priority-btn.active.low {
      border-color: var(--accent-blue);
      background: rgba(10, 132, 255, 0.2);
    }

    .priority-btn.active.normal {
      border-color: var(--accent-orange);
      background: rgba(255, 159, 10, 0.2);
    }

    .priority-btn.active.high {
      border-color: var(--accent-red);
      background: rgba(255, 69, 58, 0.2);
    }

    .subtasks-list {
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
    }

    .subtask-item input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 15px;
      outline: none;
    }

    .subtask-delete {
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 18px;
      cursor: pointer;
    }

    .add-subtask-btn {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 2px dashed var(--text-tertiary);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--separator);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.15s;
    }

    .btn:hover {
      opacity: 0.8;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-danger {
      background: var(--accent-red);
      color: white;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        bottom: 0;
        z-index: 100;
        transition: left 0.3s;
      }

      .sidebar.open {
        left: 0;
      }

      .main-header {
        padding: 12px 16px;
      }

      .quick-add {
        padding: 12px 16px;
      }

      .reminders-list {
        padding: 8px 16px 100px;
      }

      .menu-toggle {
        display: flex !important;
      }
    }

    .menu-toggle {
      display: none;
      margin-right: 12px;
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .reminder-item {
      animation: slideIn 0.2s ease-out;
    }

    /* Search Bar */
    .search-bar {
      padding: 0 24px 12px;
      display: flex;
      gap: 12px;
    }

    .search-input {
      flex: 1;
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius-xl);
      padding: 10px 16px;
      font-size: 15px;
      color: var(--text-primary);
      outline: none;
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    /* Tags */
    .tags-section {
      padding: 0 24px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag-item {
      padding: 6px 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      font-size: 13px;
      color: var(--accent-blue);
      cursor: pointer;
      transition: background 0.15s;
    }

    .tag-item:hover {
      background: var(--bg-tertiary);
    }

    .tag-item.active {
      background: var(--accent-blue);
      color: white;
    }

    /* Bulk Actions */
    .bulk-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 12px 20px;
      display: none;
      align-items: center;
      gap: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      z-index: 50;
    }

    .bulk-bar.active {
      display: flex;
    }

    .bulk-count {
      font-weight: 600;
      font-size: 15px;
    }

    .bulk-btn {
      background: none;
      border: none;
      color: var(--accent-blue);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Recurring badge */
    .recurring-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--accent-purple);
      margin-left: 8px;
    }

    /* Checkbox for selection */
    .select-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-tertiary);
      border-radius: 4px;
      margin-right: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .select-checkbox.selected {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
    }

    .select-checkbox.selected::after {
      content: '‚úì';
      color: white;
      font-size: 12px;
    }

    /* Stats panel */
    .stats-panel {
      padding: 12px 24px;
      background: var(--bg-secondary);
      margin: 0 24px 12px;
      border-radius: var(--radius-lg);
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .stat-value.overdue { color: var(--accent-red); }
    .stat-value.due-today { color: var(--accent-orange); }
    .stat-value.high { color: var(--accent-red); }
  </style>
</head>
<body>
  <script>
    // Check for token in URL or localStorage before app loads
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get('token');
      const storedToken = localStorage.getItem('auth_token');
      
      // If token in URL, store it
      if (urlToken) {
        localStorage.setItem('auth_token', urlToken);
        // Remove token from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Set token for API calls
      window.AUTH_TOKEN = urlToken || storedToken;
    })();
  </script>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">Reminders</span>
        <button class="add-folder-btn" onclick="showFolderModal()">+</button>
      </div>

      <div class="smart-lists">
        <div class="smart-item active" data-view="today" onclick="setView('today')">
          <div class="smart-icon today">üìÖ</div>
          <span class="smart-name">Today</span>
          <span class="smart-count" id="today-count">0</span>
        </div>
        <div class="smart-item" data-view="scheduled" onclick="setView('scheduled')">
          <div class="smart-icon scheduled">üìÜ</div>
          <span class="smart-name">Scheduled</span>
          <span class="smart-count" id="scheduled-count">0</span>
        </div>
        <div class="smart-item" data-view="all" onclick="setView('all')">
          <div class="smart-icon all">üìã</div>
          <span class="smart-name">All</span>
          <span class="smart-count" id="all-count">0</span>
        </div>
        <div class="smart-item" data-view="completed" onclick="setView('completed')">
          <div class="smart-icon completed">‚úì</div>
          <span class="smart-name">Completed</span>
          <span class="smart-count" id="completed-count">0</span>
        </div>
      </div>

      <div class="folders-section" id="folders-list">
        <div class="section-title">My Lists</div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="main-header">
        <div style="display: flex; align-items: center;">
          <button class="icon-btn menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
          <h1 class="header-title" id="page-title">Today</h1>
        </div>
        <div class="header-actions">
          <button class="icon-btn" onclick="toggleSearch()" title="Search">üîç</button>
          <button class="icon-btn" onclick="toggleStats()" title="Stats">üìä</button>
          <button class="icon-btn" onclick="toggleSelectMode()" title="Select">‚òê</button>
          <button class="icon-btn" onclick="showReminderModal()">+</button>
        </div>
      </div>

      <div class="quick-add">
        <input 
          type="text" 
          class="quick-add-input" 
          id="quick-input"
          placeholder="Add a new reminder..."
          onkeypress="handleQuickAdd(event)"
        >
        <div class="quick-add-meta">
          <button class="meta-btn" onclick="setQuickDate('today')">üìÖ Today</button>
          <button class="meta-btn" onclick="setQuickDate('tomorrow')">üìÜ Tomorrow</button>
          <button class="meta-btn" onclick="setQuickDate('week')">üìå This Week</button>
          <button class="meta-btn" onclick="setQuickRecurring('daily')">üîÑ Daily</button>
          <button class="meta-btn" onclick="setQuickRecurring('weekly')">üîÑ Weekly</button>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="search-bar" id="search-bar" style="display: none;">
        <input 
          type="text" 
          class="search-input" 
          id="search-input"
          placeholder="Search reminders..."
          oninput="handleSearch(this.value)"
        >
        <button class="icon-btn" onclick="toggleSearch()">‚úï</button>
      </div>

      <!-- Tags Section -->
      <div class="tags-section" id="tags-section" style="display: none;"></div>

      <!-- Stats Panel -->
      <div class="stats-panel" id="stats-panel" style="display: none;"></div>

      <div class="reminders-list" id="reminders-list">
        <!-- Reminders rendered here -->
      </div>
    </main>
  </div>

  <!-- Reminder Modal -->
  <div class="modal-overlay" id="reminder-modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">New Reminder</span>
        <button class="modal-close" onclick="closeReminderModal()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-reminder-id">
        
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" class="form-input" id="reminder-title" placeholder="What do you need to do?">
        </div>

        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="reminder-notes" placeholder="Add details..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">List</label>
            <select class="form-select" id="reminder-folder"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Due Date</label>
            <input type="datetime-local" class="form-input" id="reminder-date">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Priority</label>
            <div class="priority-options">
              <button class="priority-btn" data-priority="low" onclick="setPriority('low')">Low</button>
              <button class="priority-btn active normal" data-priority="normal" onclick="setPriority('normal')">Normal</button>
              <button class="priority-btn" data-priority="high" onclick="setPriority('high')">High</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Repeat</label>
            <select class="form-select" id="reminder-recurring">
              <option value="">Never</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Subtasks</label>
          <div class="subtasks-list" id="subtasks-list"></div>
          <button class="add-subtask-btn" onclick="addSubtaskInput()">+ Add Subtask</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeReminderModal()">Cancel</button>
        <button class="btn btn-danger" id="delete-btn" style="display:none;" onclick="deleteReminder()">Delete</button>
        <button class="btn btn-primary" onclick="saveReminder()">Save</button>
      </div>
    </div>
  </div>

  <!-- Folder Modal -->
  <div class="modal-overlay" id="folder-modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">New List</span>
        <button class="modal-close" onclick="closeFolderModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="folder-name" placeholder="List name">
        </div>
        <div class="form-group">
          <label class="form-label">Color</label>
          <select class="form-select" id="folder-color">
            <option value="#007AFF">üîµ Blue</option>
            <option value="#30D158">üü¢ Green</option>
            <option value="#FF9F0A">üü† Orange</option>
            <option value="#FF453A">üî¥ Red</option>
            <option value="#BF5AF2">üü£ Purple</option>
            <option value="#FFD60A">üü° Yellow</option>
            <option value="#8E8E93">‚ö™ Gray</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeFolderModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveFolder()">Create</button>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-bar" id="bulk-bar">
    <span class="bulk-count" id="bulk-count">0 selected</span>
    <button class="bulk-btn" onclick="bulkComplete()">‚úì Complete</button>
    <button class="bulk-btn" onclick="bulkDelete()">üóë Delete</button>
    <button class="bulk-btn" onclick="cancelSelection()">Cancel</button>
  </div>

  <script>
    // State
    let currentView = 'today';
    let currentFolder = null;
    let folders = [];
    let reminders = [];
    let tags = [];
    let quickDate = null;
    let quickRecurring = null;
    let currentPriority = 'normal';
    let tempSubtasks = [];
    let searchQuery = '';
    let selectedTag = null;
    let selectMode = false;
    let selectedIds = new Set();
    let stats = null;

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadStats();
      document.getElementById('quick-input').focus();
      
      // Periodic refresh
      setInterval(loadData, 30000);
      setInterval(loadStats, 60000);
    });

    // API Calls
    async function loadData() {
      try {
        const headers = {};
        if (window.AUTH_TOKEN) {
          headers['Authorization'] = `Bearer ${window.AUTH_TOKEN}`;
        }
        
        const [foldersRes, remindersRes, tagsRes] = await Promise.all([
          fetch('/api/folders', { headers }),
          fetch('/api/reminders', { headers }),
          fetch('/api/tags', { headers })
        ]);
        
        // If unauthorized, redirect to auth service
        if (foldersRes.status === 401 || remindersRes.status === 401) {
          redirectToAuth();
          return;
        }
        
        folders = await foldersRes.json();
        reminders = await remindersRes.json();
        tags = await tagsRes.json();
        
        renderFolders();
        renderReminders();
        renderTags();
        updateCounts();
        populateFolderSelect();
      } catch (err) {
        console.error('Failed to load data:', err);
        redirectToAuth();
      }
    }

    function redirectToAuth() {
      const currentUrl = encodeURIComponent(window.location.href);
      window.location.href = `https://inacio-auth.fly.dev/login?returnTo=${currentUrl}`;
    }

    // Helper to get auth headers
    function authHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      if (window.AUTH_TOKEN) {
        headers['Authorization'] = `Bearer ${window.AUTH_TOKEN}`;
      }
      return headers;
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/stats', { headers: authHeaders() });
        if (res.status === 401) {
          redirectToAuth();
          return;
        }
        stats = await res.json();
        if (document.getElementById('stats-panel').style.display !== 'none') {
          renderStats();
        }
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    // Rendering
    function renderFolders() {
      const container = document.getElementById('folders-list');
      container.innerHTML = '<div class="section-title">My Lists</div>';
      
      folders.forEach(folder => {
        const count = reminders.filter(r => r.folderId === folder.id && !r.completed).length;
        const div = document.createElement('div');
        div.className = `folder-item ${currentFolder === folder.id ? 'active' : ''}`;
        div.onclick = () => setFolder(folder.id);
        div.innerHTML = `
          <div class="folder-color" style="background: ${folder.color}"></div>
          <span class="folder-icon">${folder.icon}</span>
          <span class="folder-name">${escapeHtml(folder.name)}</span>
          <span class="folder-count">${count}</span>
        `;
        container.appendChild(div);
      });
    }

    function renderReminders() {
      const container = document.getElementById('reminders-list');
      let filtered = reminders;

      // Filter based on view
      if (currentView === 'today') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        filtered = reminders.filter(r => {
          if (r.completed) return false;
          if (!r.dueDate) return false;
          const due = new Date(r.dueDate);
          return due >= today && due < tomorrow;
        });
      } else if (currentView === 'scheduled') {
        filtered = reminders.filter(r => !r.completed && r.dueDate);
      } else if (currentView === 'completed') {
        filtered = reminders.filter(r => r.completed);
      } else if (currentFolder) {
        filtered = reminders.filter(r => r.folderId === currentFolder);
      } else {
        filtered = reminders.filter(r => !r.completed);
      }

      // Filter by search
      if (searchQuery) {
        filtered = filtered.filter(r => 
          r.title.toLowerCase().includes(searchQuery) ||
          (r.notes && r.notes.toLowerCase().includes(searchQuery))
        );
      }

      // Filter by tag
      if (selectedTag) {
        filtered = filtered.filter(r => {
          const text = `${r.title} ${r.notes || ''}`.toLowerCase();
          return text.includes(selectedTag.toLowerCase());
        });
      }

      // Sort
      filtered.sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        if (a.priority !== b.priority) {
          const p = { high: 0, normal: 1, low: 2 };
          return p[a.priority] - p[b.priority];
        }
        if (a.dueDate && b.dueDate) return a.dueDate - b.dueDate;
        if (a.dueDate) return -1;
        if (b.dueDate) return 1;
        return b.createdAt - a.createdAt;
      });

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìù</div>
            <div class="empty-text">No reminders</div>
            <div class="empty-subtext">Add a new reminder to get started</div>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(r => renderReminderItem(r)).join('');
    }

    function renderReminderItem(r) {
      const folder = folders.find(f => f.id === r.folderId) || { name: 'Inbox', color: '#007AFF' };
      const dateText = formatDate(r.dueDate);
      const isOverdue = r.dueDate && !r.completed && new Date(r.dueDate) < new Date();
      const isToday = r.dueDate && isDateToday(r.dueDate);
      
      let dateClass = '';
      if (isOverdue) dateClass = 'overdue';
      else if (isToday) dateClass = 'today';

      const recurringHtml = r.recurring ? `<span class="recurring-badge">üîÑ ${r.recurring}</span>` : '';
      
      const subtasksHtml = r.subtasks?.length > 0 ? `
        <div class="subtasks-preview">
          ${r.subtasks.slice(0, 3).map(st => `
            <div class="subtask-mini ${st.completed ? 'completed' : ''}">${escapeHtml(st.title)}</div>
          `).join('')}
          ${r.subtasks.length > 3 ? `<div class="subtask-mini">+${r.subtasks.length - 3} more</div>` : ''}
        </div>
      ` : '';

      const selectHtml = selectMode ? `
        <div class="select-checkbox ${selectedIds.has(r.id) ? 'selected' : ''}" onclick="toggleSelect('${r.id}'); event.stopPropagation();"></div>
      ` : '';

      return `
        <div class="reminder-item ${r.completed ? 'completed' : ''} priority-${r.priority}" data-id="${r.id}">
          <div class="reminder-main">
            ${!selectMode ? `<div class="checkbox ${r.completed ? 'checked' : ''}" onclick="toggleComplete('${r.id}', event)"></div>` : ''}
            ${selectHtml}
            <div class="reminder-content" onclick="${selectMode ? `toggleSelect('${r.id}')` : `editReminder('${r.id}')`}">
              <div class="reminder-title">${escapeHtml(r.title)}${recurringHtml}</div>
              ${r.notes ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(r.notes)}</div>` : ''}
              <div class="reminder-meta">
                ${r.dueDate ? `<span class="reminder-date ${dateClass}">üìÖ ${dateText}</span>` : ''}
                <span class="reminder-folder" style="color: ${folder.color}">${folder.icon} ${escapeHtml(folder.name)}</span>
              </div>
              ${subtasksHtml}
            </div>
          </div>
        </div>
      `;
    }

    // Actions
    async function handleQuickAdd(e) {
      if (e.key !== 'Enter') return;
      
      const input = document.getElementById('quick-input');
      const title = input.value.trim();
      if (!title) return;

      const reminder = {
        title,
        folderId: currentFolder || 'inbox',
        dueDate: quickDate,
        priority: 'normal',
        recurring: quickRecurring
      };

      await fetch('/api/reminders', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify(reminder)
      });

      input.value = '';
      quickDate = null;
      quickRecurring = null;
      await loadData();
    }

    function setQuickDate(when) {
      const now = new Date();
      
      if (when === 'today') {
        now.setHours(17, 0, 0, 0);
        quickDate = now.getTime();
      } else if (when === 'tomorrow') {
        now.setDate(now.getDate() + 1);
        now.setHours(9, 0, 0, 0);
        quickDate = now.getTime();
      } else if (when === 'week') {
        now.setDate(now.getDate() + 7);
        now.setHours(9, 0, 0, 0);
        quickDate = now.getTime();
      }
      
      document.getElementById('quick-input').focus();
    }

    function setQuickRecurring(type) {
      quickRecurring = type;
      document.getElementById('quick-input').focus();
    }

    // Search
    function toggleSearch() {
      const bar = document.getElementById('search-bar');
      const isVisible = bar.style.display !== 'none';
      bar.style.display = isVisible ? 'none' : 'flex';
      if (!isVisible) {
        document.getElementById('search-input').focus();
      } else {
        searchQuery = '';
        document.getElementById('search-input').value = '';
        renderReminders();
      }
    }

    function handleSearch(query) {
      searchQuery = query.toLowerCase();
      renderReminders();
    }

    // Tags
    function renderTags() {
      const container = document.getElementById('tags-section');
      if (tags.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.innerHTML = tags.slice(0, 15).map(t => `
        <div class="tag-item ${selectedTag === t.name ? 'active' : ''}" onclick="selectTag('${t.name}')">
          ${t.name} (${t.count})
        </div>
      `).join('');
    }

    function selectTag(tag) {
      selectedTag = selectedTag === tag ? null : tag;
      renderTags();
      renderReminders();
    }

    // Stats
    function toggleStats() {
      const panel = document.getElementById('stats-panel');
      const isVisible = panel.style.display !== 'none';
      panel.style.display = isVisible ? 'none' : 'flex';
      if (!isVisible && stats) {
        renderStats();
      }
    }

    function renderStats() {
      if (!stats) return;
      const panel = document.getElementById('stats-panel');
      panel.innerHTML = `
        <div class="stat-item">
          <span class="stat-value">${stats.total}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-item">
          <span class="stat-value overdue">${stats.overdue}</span>
          <span class="stat-label">Overdue</span>
        </div>
        <div class="stat-item">
          <span class="stat-value due-today">${stats.dueToday}</span>
          <span class="stat-label">Due Today</span>
        </div>
        <div class="stat-item">
          <span class="stat-value high">${stats.highPriority}</span>
          <span class="stat-label">High Priority</span>
        </div>
      `;
    }

    // Selection Mode
    function toggleSelectMode() {
      selectMode = !selectMode;
      selectedIds.clear();
      updateBulkBar();
      renderReminders();
    }

    function toggleSelect(id) {
      if (selectedIds.has(id)) {
        selectedIds.delete(id);
      } else {
        selectedIds.add(id);
      }
      updateBulkBar();
      renderReminders();
    }

    function updateBulkBar() {
      const bar = document.getElementById('bulk-bar');
      const count = document.getElementById('bulk-count');
      
      if (selectMode && selectedIds.size > 0) {
        bar.classList.add('active');
        count.textContent = `${selectedIds.size} selected`;
      } else {
        bar.classList.remove('active');
      }
    }

    function cancelSelection() {
      selectMode = false;
      selectedIds.clear();
      updateBulkBar();
      renderReminders();
    }

    async function bulkComplete() {
      if (selectedIds.size === 0) return;
      
      await fetch('/api/bulk', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ action: 'complete', ids: Array.from(selectedIds) })
      });
      
      cancelSelection();
      await loadData();
    }

    async function bulkDelete() {
      if (selectedIds.size === 0) return;
      if (!confirm(`Delete ${selectedIds.size} reminders?`)) return;
      
      await fetch('/api/bulk', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ action: 'delete', ids: Array.from(selectedIds) })
      });
      
      cancelSelection();
      await loadData();
    }

    async function toggleComplete(id, event) {
      event.stopPropagation();
      const r = reminders.find(x => x.id === id);
      if (!r) return;

      await fetch(`/api/reminders/${id}`, {
        method: 'PATCH',
        headers: authHeaders(),
        body: JSON.stringify({ completed: !r.completed })
      });

      await loadData();
    }

    // View Management
    function setView(view) {
      currentView = view;
      currentFolder = null;
      
      document.querySelectorAll('.smart-item, .folder-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
      
      const titles = {
        today: 'Today',
        scheduled: 'Scheduled',
        all: 'All Reminders',
        completed: 'Completed'
      };
      document.getElementById('page-title').textContent = titles[view];
      
      renderReminders();
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
      }
    }

    function setFolder(folderId) {
      currentFolder = folderId;
      currentView = 'folder';
      
      document.querySelectorAll('.smart-item, .folder-item').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      const folder = folders.find(f => f.id === folderId);
      document.getElementById('page-title').textContent = folder?.name || 'Reminders';
      
      renderReminders();
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Modal Functions
    function showReminderModal() {
      document.getElementById('reminder-modal').classList.add('active');
      document.getElementById('reminder-title').focus();
      tempSubtasks = [];
      renderSubtasks();
    }

    function closeReminderModal() {
      document.getElementById('reminder-modal').classList.remove('active');
      clearReminderForm();
    }

    function clearReminderForm() {
      document.getElementById('edit-reminder-id').value = '';
      document.getElementById('reminder-title').value = '';
      document.getElementById('reminder-notes').value = '';
      document.getElementById('reminder-date').value = '';
      document.getElementById('delete-btn').style.display = 'none';
      setPriority('normal');
      tempSubtasks = [];
      renderSubtasks();
    }

    async function editReminder(id) {
      const r = reminders.find(x => x.id === id);
      if (!r) return;

      document.getElementById('edit-reminder-id').value = id;
      document.getElementById('reminder-title').value = r.title;
      document.getElementById('reminder-notes').value = r.notes || '';
      document.getElementById('reminder-folder').value = r.folderId;
      document.getElementById('reminder-recurring').value = r.recurring || '';
      
      if (r.dueDate) {
        const d = new Date(r.dueDate);
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        document.getElementById('reminder-date').value = d.toISOString().slice(0, 16);
      }
      
      setPriority(r.priority || 'normal');
      tempSubtasks = [...(r.subtasks || [])];
      renderSubtasks();
      
      document.getElementById('delete-btn').style.display = 'inline-block';
      document.getElementById('reminder-modal').classList.add('active');
    }

    function setPriority(p) {
      currentPriority = p;
      document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.priority === p);
      });
    }

    function addSubtaskInput() {
      tempSubtasks.push({ id: `temp-${Date.now()}`, title: '', completed: false });
      renderSubtasks();
      const inputs = document.querySelectorAll('.subtask-item input');
      inputs[inputs.length - 1]?.focus();
    }

    function renderSubtasks() {
      const container = document.getElementById('subtasks-list');
      container.innerHTML = tempSubtasks.map((st, i) => `
        <div class="subtask-item">
          <input 
            type="text" 
            value="${escapeHtml(st.title)}" 
            placeholder="Subtask..."
            oninput="updateSubtask(${i}, this.value)"
          >
          <button class="subtask-delete" onclick="removeSubtask(${i})">√ó</button>
        </div>
      `).join('');
    }

    function updateSubtask(i, value) {
      tempSubtasks[i].title = value;
    }

    function removeSubtask(i) {
      tempSubtasks.splice(i, 1);
      renderSubtasks();
    }

    async function saveReminder() {
      const id = document.getElementById('edit-reminder-id').value;
      const reminder = {
        title: document.getElementById('reminder-title').value,
        notes: document.getElementById('reminder-notes').value,
        folderId: document.getElementById('reminder-folder').value,
        dueDate: document.getElementById('reminder-date').value || null,
        priority: currentPriority,
        recurring: document.getElementById('reminder-recurring').value || null,
        subtasks: tempSubtasks.filter(st => st.title.trim())
      };

      if (!reminder.title.trim()) {
        alert('Please enter a title');
        return;
      }

      const headers = authHeaders();

      if (id) {
        await fetch(`/api/reminders/${id}`, {
          method: 'PATCH',
          headers,
          body: JSON.stringify(reminder)
        });
      } else {
        await fetch('/api/reminders', {
          method: 'POST',
          headers,
          body: JSON.stringify(reminder)
        });
      }

      closeReminderModal();
      await loadData();
    }

    async function deleteReminder() {
      const id = document.getElementById('edit-reminder-id').value;
      if (!id) return;
      
      if (!confirm('Delete this reminder?')) return;
      
      await fetch(`/api/reminders/${id}`, { method: 'DELETE', headers: authHeaders() });
      closeReminderModal();
      await loadData();
    }

    // Folder Modal
    function showFolderModal() {
      document.getElementById('folder-modal').classList.add('active');
      document.getElementById('folder-name').focus();
    }

    function closeFolderModal() {
      document.getElementById('folder-modal').classList.remove('active');
      document.getElementById('folder-name').value = '';
    }

    async function saveFolder() {
      const name = document.getElementById('folder-name').value.trim();
      const color = document.getElementById('folder-color').value;
      
      if (!name) {
        alert('Please enter a name');
        return;
      }

      await fetch('/api/folders', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ name, color, icon: 'üìÅ' })
      });

      closeFolderModal();
      await loadData();
    }

    // Helpers
    function populateFolderSelect() {
      const select = document.getElementById('reminder-folder');
      select.innerHTML = folders.map(f => `
        <option value="${f.id}">${escapeHtml(f.name)}</option>
      `).join('');
    }

    function updateCounts() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      document.getElementById('today-count').textContent = reminders.filter(r => {
        if (r.completed || !r.dueDate) return false;
        const due = new Date(r.dueDate);
        return due >= today && due < tomorrow;
      }).length;

      document.getElementById('scheduled-count').textContent = reminders.filter(r => !r.completed && r.dueDate).length;
      document.getElementById('all-count').textContent = reminders.filter(r => !r.completed).length;
      document.getElementById('completed-count').textContent = reminders.filter(r => r.completed).length;
    }

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const dateDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());

      if (dateDay.getTime() === today.getTime()) {
        return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      } else if (dateDay.getTime() === tomorrow.getTime()) {
        return 'Tomorrow';
      } else {
        return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
      }
    }

    function isDateToday(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      return date.toDateString() === now.toDateString();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.classList.remove('active');
      });
    });

    // Prevent rubber band scrolling on body only, allow in scrollable containers
    document.body.addEventListener('touchmove', function(e) {
      // Only prevent if not in a scrollable container
      const scrollable = e.target.closest('.folders-section, .reminders-list, .modal-body, .subtasks-list');
      if (!scrollable) {
        e.preventDefault();
      }
    }, { passive: false });

    // Prevent pull-to-refresh on body
    let startY = 0;
    document.body.addEventListener('touchstart', function(e) {
      if (e.touches.length === 1) {
        startY = e.touches[0].clientY;
      }
    }, { passive: true });
  </script>
  <script>
    // Check for token in URL or localStorage before app loads
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get('token');
      let storedToken = null;
      
      // Try to get from localStorage, but handle iOS private mode
      try {
        storedToken = localStorage.getItem('auth_token');
      } catch (e) {
        console.log('localStorage not available (private mode?)');
      }
      
      console.log('Auth check:', { hasUrlToken: !!urlToken, hasStoredToken: !!storedToken });
      
      // If token in URL, store it
      if (urlToken) {
        try {
          localStorage.setItem('auth_token', urlToken);
          console.log('Token stored from URL');
        } catch (e) {
          console.log('Could not store token in localStorage');
        }
        // Remove token from URL but keep it in memory
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Set token for API calls - prefer URL token if just received
      window.AUTH_TOKEN = urlToken || storedToken;
      
      // If no token at all, redirect to auth service immediately
      if (!window.AUTH_TOKEN) {
        console.log('No token found, redirecting to auth...');
        const currentUrl = encodeURIComponent(window.location.href);
        window.location.href = `https://inacio-auth.fly.dev/login?returnTo=${currentUrl}`;
      } else {
        console.log('Token found, proceeding...');
      }
    })();
  </script>
</body>
</html>
